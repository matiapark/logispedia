<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë¬¼ë¥˜ ìš©ì–´ ë‹¤ì¤‘ ë“±ë¡</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    .status { margin-top: 20px; white-space: pre-wrap; font-size: 14px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ ë¬¼ë¥˜ ìš©ì–´ ë‹¤ì¤‘ ë“±ë¡ (CSV íŒŒì¼)</h2>
  <p>CSV íŒŒì¼ì˜ ì²« ë²ˆì§¸ ì—´ì€ ë°˜ë“œì‹œ <code>term</code> ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</p>

  <input type="file" id="fileInput" accept=".csv" />
  <button onclick="uploadFile()">ì—…ë¡œë“œ ë° ë“±ë¡</button>

  <div class="status" id="statusBox"></div>

<script>
  const baseUrl = "https://2hmtyf2t9e.execute-api.ap-northeast-2.amazonaws.com/prod/LogisticsDictionaryBatchAPI";

  async function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const statusBox = document.getElementById("statusBox");
    statusBox.innerText = "ğŸ“‘ CSV íŒŒì¼ ì½ëŠ” ì¤‘...";

    if (!fileInput.files[0]) {
      alert("CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    const file = fileInput.files[0];
    const text = await file.text();
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");
    const termIndex = headers.findIndex(h => h.trim().toLowerCase() === "term");

    if (termIndex === -1) {
      alert("CSV íŒŒì¼ì— 'term' í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const terms = rows.slice(1).map(row => row.split(",")[termIndex].trim()).filter(t => t);
    if (terms.length === 0) {
      alert("ë“±ë¡í•  ìš©ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    statusBox.innerText = `ì´ ${terms.length}ê°œ ìš©ì–´ ì²˜ë¦¬ ì¤‘...`;
    let success = 0, fail = 0;
    const failedTerms = [];  // ì‹¤íŒ¨í•œ ìš©ì–´ ëª©ë¡

    for (let i = 0; i < terms.length; i++) {
      const term = terms[i];
      statusBox.innerText = `ğŸ”„ (${i + 1}/${terms.length}) ${term} ì²˜ë¦¬ ì¤‘...\nì„±ê³µ: ${success}, ì‹¤íŒ¨: ${fail}`;

      try {
        const res = await fetch(baseUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ term })
        });

        const data = await res.json();
        if (res.ok && data.status === "success") {
          success++;
        } else {
          fail++;
          failedTerms.push(term);
        }
      } catch (err) {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
        fail++;
        failedTerms.push(term);
      }
    }

    statusBox.innerText = `ğŸ‰ ì™„ë£Œ: ${success}ê°œ ë“±ë¡ ì„±ê³µ, ${fail}ê°œ ì‹¤íŒ¨`;

    // ì‹¤íŒ¨í•œ ìš©ì–´ CSV ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„±
    if (failedTerms.length > 0) {
      const csvContent = "\uFEFFterm\n" + failedTerms.map(t => `"${t}"`).join("\n"); // UTF-8 BOM í¬í•¨
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const downloadLink = document.createElement("a");
      downloadLink.href = url;
      downloadLink.download = "failed_terms.csv";
      downloadLink.innerText = "ğŸ“¥ ì‹¤íŒ¨í•œ ìš©ì–´ CSV ë‹¤ìš´ë¡œë“œ";
      downloadLink.style.display = "inline-block";
      downloadLink.style.marginTop = "15px";
      downloadLink.style.fontWeight = "bold";

      statusBox.appendChild(document.createElement("br"));
      statusBox.appendChild(downloadLink);
    }
  }
</script>
</body>
</html>

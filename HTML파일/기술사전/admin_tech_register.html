<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê¸°ìˆ  ìš©ì–´ ë“±ë¡ - Input ë°©ì‹</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }

    input, textarea {
      width: 100%;
      margin: 5px 0;
      padding: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    .row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-top: 5px;
    }

    .row input {
      display: block;
      padding: 8px;
      line-height: 1.4;
      font-size: 14px;
      height: 100%;
      align-self: stretch;
      box-sizing: border-box;
      word-break: break-word;
      white-space: normal;
    }

    .row input:nth-child(1) {
      flex: 2.5;
      min-width: 180px;
      font-weight: normal;
    }

    .row input:nth-child(2),
    .row input:nth-child(3),
    .row input:nth-child(4) {
      flex: 2;
      min-width: 160px;
    }

    .row button {
      align-self: flex-start;
      height: 38px;
      margin-top: 2px;
      background-color: #ffdddd;
      border: 1px solid #cc0000;
    }

    button {
      padding: 6px 12px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>ğŸ›  ê¸°ìˆ  ìš©ì–´ ë“±ë¡ (Input)</h2>
  <label>ê¸°ìˆ  ìš©ì–´ (term)</label>
  <input id="termInput" placeholder="ì˜ˆ: AGV (Automated Guided Vehicle)" />

  <label>ë‹µë³€ (answer)</label>
  <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <button onclick="generateAnswer()">ğŸ§  GPTë¡œ ë‹µë³€ ìƒì„±</button>
      <span id="loadingStatus" style="font-weight: bold; color: #555;"></span>
    </div>
    <button onclick="location.href='https://encyclopedia-of-tech.s3.ap-northeast-2.amazonaws.com/admin_tech_bulk_upload.html'">ğŸ“‚ Batch File</button>
    <button onclick="loadFromDB()" style="margin-left:auto;">ğŸ“¥ ì—…ë¡œë“œ ìš”ì²­</button>
  </div>

  <textarea id="answerInput" rows="12"></textarea>

  <label style="margin-top: 10px;">ê³µê¸‰ì—…ì²´ ì •ë³´</label>
  <div id="supplierList"></div>
  <div style="display: flex; gap: 10px; margin-top: 10px;">
    <button onclick="addSupplierRow()">â• ê³µê¸‰ì—…ì²´ ì¶”ê°€</button>
    <button onclick="submitEntry()">ğŸ’¾ ì €ì¥</button>
  </div>

<script>
function addSupplierRow(company="", product="", homepage="", youtube="") {
  const list = document.getElementById("supplierList");
  const div = document.createElement("div");
  div.className = "row";
  div.innerHTML = `
    <input placeholder="íšŒì‚¬ëª…" value="${company}">
    <input placeholder="ì·¨ê¸‰ì œí’ˆ" value="${product}">
    <input placeholder="í™ˆí˜ì´ì§€" value="${homepage}">
    <input placeholder="ìœ íŠœë¸Œ" value="${youtube}">
    <button onclick="this.parentElement.remove()">ì‚­ì œ</button>
  `;
  list.appendChild(div);
}

async function generateAnswer() {
  const rawTerm = document.getElementById("termInput").value.trim();
  const statusEl = document.getElementById("loadingStatus");

  if (!rawTerm) {
    alert("ìš©ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    return;
  }

  statusEl.textContent = "ìƒì„± ì¤‘...";

  try {
    const res = await fetch(`https://dp3x06ffyf.execute-api.ap-northeast-2.amazonaws.com/prod/generateTechAnswer?q=${encodeURIComponent(rawTerm)}`);
    const raw = await res.json();
    const data = typeof raw.body === "string" ? JSON.parse(raw.body) : raw;

    if (data.answer) {
      document.getElementById("answerInput").value = data.answer;
    } else {
      alert("GPTê°€ ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
  } catch (err) {
    console.error("GPT ìƒì„± ì˜¤ë¥˜:", err);
    alert("GPT í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
  } finally {
    statusEl.textContent = "";
  }
}

async function loadFromDB() {
  const term = document.getElementById("termInput").value.trim();
  if (!term) return alert("ê¸°ìˆ  ìš©ì–´(term)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

  try {
    const res = await fetch(`https://dp3x06ffyf.execute-api.ap-northeast-2.amazonaws.com/prod/getTechTerm?q=${encodeURIComponent(term)}`);
    const raw = await res.json();
    const data = typeof raw.body === "string" ? JSON.parse(raw.body) : raw;

    if (data.term) document.getElementById("termInput").value = data.term;
    if (data.answer) document.getElementById("answerInput").value = data.answer;

    if (data.suppliers && Array.isArray(data.suppliers)) {
      const supplierList = document.getElementById("supplierList");
      supplierList.innerHTML = "";
      data.suppliers.forEach(s => addSupplierRow(s.company, s.product, s.homepage, s.youtube));
    }
  } catch (err) {
    alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    console.error(err);
  }
}

async function submitEntry() {
  const term = document.getElementById("termInput").value.trim();
  const answer = document.getElementById("answerInput").value.trim();
  if (!term || !answer) return alert("termê³¼ answerëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");

  const rows = document.querySelectorAll("#supplierList .row");
  const suppliers = Array.from(rows).map(row => {
    const inputs = row.querySelectorAll("input");
    return {
      company: inputs[0].value,
      product: inputs[1].value,
      homepage: inputs[2].value,
      youtube: inputs[3].value
    };
  });

  const payload = { term, answer, suppliers };

  try {
    const res = await fetch("https://dp3x06ffyf.execute-api.ap-northeast-2.amazonaws.com/prod/registerTechTerm", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    alert(result.message || "ì €ì¥ ì™„ë£Œ");
  } catch (err) {
    alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    console.error("ì €ì¥ ì‹¤íŒ¨ ìƒì„¸:", err);
  }
}
</script>
</body>
</html>

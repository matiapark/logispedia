
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê¸°ìˆ  ìš©ì–´ ë‹¤ì¤‘ ë“±ë¡</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    .status { margin-top: 20px; white-space: pre-wrap; font-size: 14px; }
  </style>
</head>
<body>
  <h2>ğŸ“¤ ê¸°ìˆ  ìš©ì–´ ë‹¤ì¤‘ ë“±ë¡ (CSV íŒŒì¼)</h2>
  <button onclick="location.href='https://encyclopedia-of-tech.s3.ap-northeast-2.amazonaws.com/admin_tech_register.html'">ğŸ”™ Back to Admin</button>
  <p>CSV íŒŒì¼ì˜ ì²« ë²ˆì§¸ ì—´ì€ ë°˜ë“œì‹œ <code>term</code> ì´ì–´ì•¼ í•©ë‹ˆë‹¤.</p>

  <input type="file" id="fileInput" accept=".csv" />
  <button onclick="uploadFile()">ì—…ë¡œë“œ ë° ì²˜ë¦¬</button>
  <button onclick="downloadFailedCSV()" style="margin-left: 10px;">ğŸ“¥ ì‹¤íŒ¨ ëª©ë¡ ë‹¤ìš´ë¡œë“œ</button>

  <div class="status" id="statusBox">ì²˜ë¦¬ ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

<script>
  const baseUrl = "https://zi7syvnl2b.execute-api.ap-northeast-2.amazonaws.com/prod";
  let failedTerms = [];

  async function uploadFile() {
    const fileInput = document.getElementById("fileInput");
    const statusBox = document.getElementById("statusBox");
    statusBox.innerText = "ğŸ“‘ CSV íŒŒì¼ ì½ëŠ” ì¤‘...";
    failedTerms = [];

    if (!fileInput.files[0]) {
      alert("CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
      return;
    }

    const file = fileInput.files[0];
    const text = await file.text();
    const rows = text.trim().split("\n");
    const headers = rows[0].split(",");
    const termIndex = headers.findIndex(h => h.trim().toLowerCase() === "term");

    if (termIndex === -1) {
      alert("CSV íŒŒì¼ì— 'term' í—¤ë”ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const terms = rows.slice(1).map(row => row.split(",")[termIndex].trim()).filter(t => t);

    if (terms.length === 0) {
      alert("ë“±ë¡í•  ìš©ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    statusBox.innerText = `ì´ ${terms.length}ê°œ ìš©ì–´ ì²˜ë¦¬ ì¤‘...`;
    let success = 0, fail = 0;

    for (let i = 0; i < terms.length; i++) {
      const term = terms[i];
      statusBox.innerText = `ğŸ”„ (${i + 1}/${terms.length}) ${term} ì²˜ë¦¬ ì¤‘...\nì„±ê³µ: ${success}, ì‹¤íŒ¨: ${fail}`;

      try {
        const res = await fetch(`${baseUrl}/registerOneTerm`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ term })
        });

        const data = await res.json();
        if (res.ok && data.status === "success") {
          success++;
        } else {
          fail++;
          failedTerms.push(term);
        }
      } catch (err) {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
        fail++;
        failedTerms.push(term);
      }
    }

    statusBox.innerText = `ğŸ‰ ì™„ë£Œ: ${success}ê°œ ë“±ë¡ ì„±ê³µ, ${fail}ê°œ ì‹¤íŒ¨\n` +
                          (failedTerms.length ? `âŒ ì‹¤íŒ¨í•œ ìš©ì–´:\n- ${failedTerms.join("\n- ")}` : "");
  }

  function downloadFailedCSV() {
    if (failedTerms.length === 0) {
      alert("ì‹¤íŒ¨í•œ ìš©ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }

    const csvContent = "term\n" + failedTerms.map(term => `"${term}"`).join("\n");
    const BOM = "\uFEFF";
    const blob = new Blob([BOM + csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "failed_terms.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>
</body>
</html>
